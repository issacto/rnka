# React Native Key Attestation - Step-by-Step Guide

## Goal:

Implement a React Native module that uses Key Attestation to ensure cryptographic keys are securely generated on the client device. Attestation will be validated on a Spring Boot backend. Both Android and iOS platforms are supported, despite using different mechanisms.

---

## 1. Project Setup

- Create a new React Native native module that includes:
  - Android native code (Java or Kotlin)
  - iOS native code (Swift or Objective-C)
- The module should provide functions to:
  - Generate secure keys
  - Retrieve attestation certificate data
  - Send this data to the backend for verification

---

## 2. Android Attestation

- Use the Android Keystore API to generate a new hardware-backed key.
- Set an attestation challenge when creating the key.
- Generate the key using `KeyGenParameterSpec`.
- Retrieve the attestation certificate chain using the `KeyStore` API.
- The certificate chain includes details that prove:
  - The key was generated in a secure environment.
  - The device is not rooted or compromised.
  - The challenge is present in the certificate fields.
- Encode the entire certificate chain to Base64 format.

---

## 3. iOS Attestation

- Use Apple’s Keychain API to generate a key inside the Secure Enclave.
- Set the attribute to request an attestation certificate.
- This is only supported on iOS 14+ and A12+ chip devices.
- Retrieve the attestation certificate chain from the key attributes.
- This certificate proves the key was generated by the Secure Enclave.
- Encode the certificate chain to Base64 format.

---

## 4. Send Attestation to Backend

- From the React Native app, send the following data to your backend:
  - Attestation certificate chain (Base64 encoded).
  - Public key (optional).
  - The attestation challenge used.
  - Optional metadata (such as OS version or device model).

---

## 5. Backend Verification (Spring Boot)

- Implement an API endpoint that receives the attestation data.
- On the backend:
  - Decode the Base64 certificate chain.
  - Verify the certificate chain using standard X.509 validation.
  - For Android: ensure the chain is signed by Google’s root CA.
  - For iOS: ensure the chain is signed by Apple’s attestation CA (if available).
  - Parse the attestation certificate fields.
  - Validate that:
    - The key is hardware-backed.
    - The challenge matches what the server originally sent.
    - The key was not generated in a software-only or emulated environment.
- Return a verification result to the client.

---

## 6. Challenge Origin

- Always use a server-generated challenge when generating the key.
- This challenge should be:
  - Random and unpredictable.
  - Unique per session or user.
  - Expire quickly (e.g. in a few minutes).
- This ensures that the attestation is fresh and prevents replay attacks.

---

## 7. Attestation Lifetime

- Attestation results should not be treated as permanent.
- Devices can be compromised after a successful attestation.
- It is recommended to:
  - Require re-attestation after a set period (e.g. every 7 or 30 days).
  - Attach expiration timestamps to tokens or trust flags based on attestation.

---

## 8. Device Compatibility

- Android:
  - Supported on Android 7.0 and above (API 24+).
  - Full attestation details available from Android 8.0 (API 26+).
- iOS:
  - Supported only on devices with Secure Enclave (A12 chip and newer).
  - Requires iOS 14 or higher.
- Implement fallback behavior or reduced functionality for unsupported devices.

---
